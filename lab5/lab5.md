1.
С помощью Helm установим Prometheus и Grafana. Выполним следующие команды для установки в нашем кластере:
![](images/1.png)

Создадим отдельный неймспейс для мониторинга:
```
kubectl create namespace monitoring
```

Установим Prometheus
![](images/2.png)

Установим Grafana
![](images/3.png)

Проверить успешность установки можно так
![](images/4.png)

2.
Настроим сервис для мониторинга Prometheus. Prometheus должен знать, что наш сервис можно мониторить, поэтому добавим аннотации к YAML-файлу сервиса
Эти аннотации указывают Prometheus, что сервис доступен для сбора метрик.
![](images/5.png)

3. Вход в Grafana

Чтобы получить пароль администратора Grafana, выполним команду, предложенную в первом пункте при установке Grafana, 
но  команда base64 недоступна в командной строке Windows. Поэтому мы получили admin-password, закодированный в base64, и расшифровали его вручную, используя онлайн-декодер
![](images/7.png)

![](images/8.png)

После этого откроим браузер и перейдем по адресу http://localhost:3000, используя учетные данные 
(имя пользователя по умолчанию: admin, получение пароля представлено выше).
![](images/6.png)

![](images/9.png)

4. Создание графиков

Добавим источник данных Prometheus, для этого в Connections -> Data sources добавим новый источник с типом Prometheus 
и укажем URL-адрес Prometheus-сервера (http://prometheus-service.monitoring.svc.cluster.local:80).
![](images/10.png)

Теперь мы можем создать дашборды, чтобы наблюдать метрики сервиса с помощью PromQL-запросов.
На рисунке ниже представно создание запроса, который показывает текущее потребление памяти подами в байтах.
```
sum(container_memory_usage_bytes{namespace="default"}) by (pod)
```
![](images/11.png)

Второй график показывает среднее потребление CPU для каждого пода в namespace default, усреднённое за последние 5 минут. Это значение измеряется в "долях процессора в секунду" (например, 0.5 означает использование 50% одного процессорного ядра).
```
sum(rate(container_cpu_usage_seconds_total{namespace="default"}[5m])) by (pod)
```
![](images/12.png)

Оба графика можно посмотреть в разделе Дашборды.
![](images/13.png)
